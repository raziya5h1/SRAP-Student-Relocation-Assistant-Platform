<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SRAP â€” Donations & My Requests</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-blue-50 min-h-screen p-8">

<h1 class="text-3xl font-bold text-blue-700 text-center mb-6">Donations Dashboard</h1>

<!-- Tabs -->
<div class="mb-6 flex border-b border-gray-300">
  <button id="tab-available" class="px-4 py-2 font-semibold border-b-2 border-blue-700">Available Donations</button>
  <button id="tab-myrequests" class="px-4 py-2 font-semibold text-gray-500 hover:text-blue-700">My Requests</button>
</div>

<!-- Available Donations -->
<div id="availableTab">
  {% if donations %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for d in donations %}
    <div class="bg-white shadow-xl rounded-2xl p-4 transition transform hover:scale-105 hover:shadow-2xl">
      <img src="{{ url_for('static', filename='uploads/' + (d.image or 'default.jpg')) }}" class="w-full h-48 object-cover rounded-xl mb-3">
      <h2 class="text-xl font-bold text-gray-800">{{ d.item_name }}</h2>
      <p class="text-gray-600">{{ d.category or 'No category' }} | Qty: {{ d.quantity }}</p>
      <p class="text-sm text-gray-500 mt-2">By {{ d.donor_name }} ({{ d.donor_location or 'Unknown' }})</p>
      <p class="text-sm text-gray-500 mt-1">Condition: {{ d.condition or 'N/A' }}</p>
      <button onclick="openRequestModal({{ d.id }}, '{{ d.item_name }}')" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700 w-full transition">Request Item</button>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-center text-gray-600 text-lg mt-10">No available donations at the moment.</p>
  {% endif %}
</div>

<!-- My Requests -->
<div id="myRequestsTab" class="hidden">
  <div id="myRequestsContainer">
    {% if requests %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for r in requests %}
      <div class="bg-white shadow-lg rounded-2xl p-4 hover:shadow-2xl transition">
        <h2 class="text-xl font-semibold text-gray-800">{{ r.donation.item_name }}</h2>
        <p class="text-gray-600 mb-1">Donor: {{ r.donation.donor_name }}</p>
        <p class="text-gray-600 mb-1">Quantity: {{ r.donation.quantity }}</p>
        <p class="text-gray-600 mb-1">Pickup: {{ r.donation.collection_location }}</p>
        <p class="text-gray-600 mb-1">Status:
          <span class="font-semibold {% if r.status=='accepted' %}text-green-600{% elif r.status=='declined' %}text-red-600{% else %}text-yellow-600{% endif %}">
            {{ r.status.capitalize() }}
          </span>
        </p>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-gray-600 text-lg mt-10">You have not requested any items yet.</p>
    {% endif %}
  </div>
</div>

<!-- Request Modal -->
<div id="requestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
  <div class="bg-white p-6 rounded-2xl w-96 shadow-2xl">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Request Item: <span id="itemName"></span></h2>
    <form id="requestForm">
      <input type="hidden" id="donationId">
      <input type="text" id="requester_name" name="requester_name" placeholder="Your Name" required class="w-full border p-2 rounded mb-2">
      <input type="email" id="requester_email" name="requester_email" placeholder="Your Email" required class="w-full border p-2 rounded mb-2">
      <input type="text" id="requester_area" name="requester_area" placeholder="Your Area" class="w-full border p-2 rounded mb-2">
      <textarea id="message" name="message" placeholder="Message (optional)" class="w-full border p-2 rounded mb-3"></textarea>
      <div class="flex justify-between">
        <button type="button" onclick="closeRequestModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send Request</button>
      </div>
    </form>
  </div>
</div>

<script>
const availableTabBtn = document.getElementById("tab-available");
const myRequestsTabBtn = document.getElementById("tab-myrequests");
const availableTab = document.getElementById("availableTab");
const myRequestsTab = document.getElementById("myRequestsTab");

availableTabBtn.addEventListener("click", () => {
  availableTab.classList.remove("hidden");
  myRequestsTab.classList.add("hidden");
  availableTabBtn.classList.add("border-blue-700");
  myRequestsTabBtn.classList.remove("border-blue-700");
});

myRequestsTabBtn.addEventListener("click", () => {
  myRequestsTab.classList.remove("hidden");
  availableTab.classList.add("hidden");
  myRequestsTabBtn.classList.add("border-blue-700");
  availableTabBtn.classList.remove("border-blue-700");
});

function openRequestModal(id, name) {
  document.getElementById("requestModal").classList.remove("hidden");
  document.getElementById("itemName").innerText = name;
  document.getElementById("donationId").value = id;
}
function closeRequestModal() { document.getElementById("requestModal").classList.add("hidden"); }

document.getElementById("requestForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("donationId").value;
  const formData = new FormData(e.target);
  const res = await fetch(`/request_item/${id}`, { method: "POST", body: formData });
  const data = await res.json();
  if (data.status === "success") {
    Swal.fire("Success!", "Your request has been sent.", "success");
    closeRequestModal();
    const container = document.getElementById("myRequestsContainer");
    const html = `<div class="bg-white shadow-lg rounded-2xl p-4 hover:shadow-2xl transition mt-4">
      <h2 class="text-xl font-semibold text-gray-800">${formData.get('requester_name')} requested: ${document.getElementById('itemName').innerText}</h2>
      <p class="text-gray-600 mb-1">Status: <span class="font-semibold text-yellow-600">Pending</span></p>
    </div>`;
    if(container.querySelector('p')) { container.innerHTML = html; } else { container.insertAdjacentHTML('beforeend', html); }
  } else { Swal.fire("Error", data.message, "error"); }
});
</script>

</body>
</html>
