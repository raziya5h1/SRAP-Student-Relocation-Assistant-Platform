<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SRAP ‚Äî Doc Helper</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background: linear-gradient(to right, #f9fafb, #e0e7ff); font-family: "Poppins", sans-serif; }
    .step-card { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 700px; margin: 2rem auto; }
    .hidden { display: none; }
    .file-preview { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .file-preview div { background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .remove-btn { color: #ef4444; cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <div class="step-card">
    <h1 class="text-2xl font-bold text-indigo-600 mb-4 text-center">üìÑ SRAP ‚Äî Document Helper</h1>

    <!-- Step 1 -->
    <form id="step1" class="step">
      <h2 class="text-lg font-semibold mb-2">Step 1: Location & College</h2>
      <button type="button" id="detectLocation" class="bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600 mb-3">Detect My Location üìç</button>
      <input type="text" id="location" name="location" placeholder="Detected Location" readonly class="w-full border rounded p-2 mb-3 bg-gray-100" />
      <input list="collegeList" id="college" name="college" placeholder="Search college" class="w-full border rounded p-2 mb-3" />
      <datalist id="collegeList"></datalist>
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded float-right hover:bg-green-600">Next ‚Üí</button>
    </form>

    <!-- Step 2 -->
    <form id="step2" class="step hidden">
      <h2 class="text-lg font-semibold mb-2">Step 2: Choose Process</h2>
      <select id="process" name="process" class="w-full border rounded p-2 mb-3">
        <option value="">Select a process</option>
        <option value="Bonafide Certificate">Bonafide Certificate</option>
        <option value="Study Certificate">Study Certificate</option>
        <option value="Fee Receipt">Fee Receipt</option>
        <option value="TC / Migration">TC / Migration</option>
      </select>
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded float-right hover:bg-green-600">Next ‚Üí</button>
    </form>

    <!-- Step 3 -->
    <form id="step3" class="step hidden" enctype="multipart/form-data">
      <h2 class="text-lg font-semibold mb-2">Step 3: Enter Details & Upload Documents</h2>
      <input type="text" id="name" name="name" placeholder="Full Name" class="w-full border rounded p-2 mb-2" required />
      <input type="text" id="roll" name="roll" placeholder="Roll Number" class="w-full border rounded p-2 mb-2" required />
      <input type="text" id="branch" name="branch" placeholder="Branch" class="w-full border rounded p-2 mb-2" required />
      <input type="text" id="year" name="year" placeholder="Year" class="w-full border rounded p-2 mb-2" required />
      <label class="font-medium">Upload Required Documents:</label>
      <input type="file" id="documents" name="documents" multiple class="w-full border rounded p-2 mb-2" />
      <div class="file-preview" id="filePreview"></div>
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded float-right hover:bg-green-600">Submit ‚Üí</button>
    </form>

    <!-- Step 4 -->
    <div id="step4" class="step hidden">
      <h2 class="text-lg font-semibold mb-2">Step 4: Review & Request Admin</h2>
      <div id="summaryData" class="bg-gray-50 border rounded p-3 mb-3"></div>
      <button id="requestAdmin" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">Request Admin</button>
      <button id="doneBtn" class="bg-green-500 text-white px-4 py-2 rounded float-right hover:bg-green-600">Done</button>
    </div>
  </div>

<script>
const steps = ["step1","step2","step3","step4"];

// Show one step
function showStep(stepNum){ steps.forEach((s,i)=>document.getElementById(s).classList.toggle("hidden", i!==stepNum-1)); }

// File preview
const fileInput = document.getElementById("documents");
const filePreview = document.getElementById("filePreview");
fileInput.addEventListener("change", ()=>{
  filePreview.innerHTML = "";
  Array.from(fileInput.files).forEach(file=>{
    const div=document.createElement("div");
    div.innerHTML=`${file.name} <span class="remove-btn" onclick="removeFile('${file.name}')">‚úï</span>`;
    filePreview.appendChild(div);
  });
});
// Keep track of removed files
let removedFiles = [];

function removeFile(filename) {
  removedFiles.push(filename);
  // Remove visually from preview
  const previewItems = Array.from(filePreview.children);
  previewItems.forEach(div => {
    if (div.textContent.includes(filename)) div.remove();
  });
  Swal.fire("Removed", filename + " removed successfully", "info");
}


// Step 1 submit
document.getElementById("step1").addEventListener("submit", async (e) => {
  e.preventDefault();

  const location = document.getElementById("location").value.trim();
  const college = document.getElementById("college").value.trim();

  if (!location || !college) {
    Swal.fire("Warning", "Please detect location & select college", "warning");
    return;
  }

  // ‚úÖ Fix undefined lat/lon by safely referencing stored values
  const lat = window.userLat || "";
  const lon = window.userLon || "";

  const res = await fetch("/doc_helper", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      step: "1",
      location,
      college,
      latitude: lat,
      longitude: lon
    })
  });

  const data = await res.json();

  if (data.status === "success") {
    // ‚úÖ Populate college list dynamically from backend
    if (data.colleges && data.colleges.length) {
      const list = document.getElementById("collegeList");
      list.innerHTML = "";
      data.colleges.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.name;
        list.appendChild(opt);
      });
    }

    // ‚úÖ Move to next step
    if (data.next_step === 2) showStep(2);
  } else {
    Swal.fire("Error", data.message || "Could not proceed", "error");
  }
});


// Step 2 submit
document.getElementById("step2").addEventListener("submit", async e=>{
  e.preventDefault();
  const process = document.getElementById("process").value;
  if(!process){ Swal.fire("Warning","Please choose a process","warning"); return; }
  const res = await fetch("/doc_helper", { method:"POST", body:new URLSearchParams({step:"2", process}) });
  const data = await res.json();
  if(data.next_step===3) showStep(3);
});

// Step 3 submit (with remove_files coordination)
document.getElementById("step3").addEventListener("submit", async e => {
  e.preventDefault();

  const formData = new FormData(e.target);
  formData.append("step", "3");

  // ‚úÖ Send names of removed files to backend
  removedFiles.forEach(f => formData.append("remove_files[]", f));

  const res = await fetch("/doc_helper", { method: "POST", body: formData });
  const data = await res.json();

  if (data.next_step === 4) {
    const summaryDiv = document.getElementById("summaryData");
    summaryDiv.innerHTML = `
      <p><strong>Location:</strong> ${data.location}</p>
      <p><strong>College:</strong> ${data.college}</p>
      <p><strong>Process:</strong> ${data.process}</p>
      <p><strong>Name:</strong> ${data.name}</p>
      <p><strong>Branch:</strong> ${data.branch}</p>
      <p><strong>Year:</strong> ${data.year}</p>
      <p><strong>Roll:</strong> ${data.roll}</p>
      <p><strong>Submitted On:</strong> ${data.submitted_on}</p>
      <div class="file-preview">
        ${data.files.map(f => `
          <div class="file-item">
            <a href="/uploads/${data.user_email}/${f.stored}" target="_blank">${f.display}</a>
            <span class="text-xs text-gray-500 ml-2">(${f.uploaded_at})</span>
          </div>
        `).join('')}
      </div>
    `;
    showStep(4);
 }
 else {
    Swal.fire("Error", data.message || "Upload failed", "error");
  }
});


// ‚úÖ Request admin with animation + success sound
document.getElementById("requestAdmin").addEventListener("click", async () => {
  // Extract data from summary
  const summaryDiv = document.getElementById("summaryData");
  const process = summaryDiv.querySelector("p:nth-child(3)")?.textContent?.split(": ")[1] || "";
  const docName = summaryDiv.querySelector("p:nth-child(7)")?.textContent?.split(": ")[1] || "";

  // Confirmation popup
  const confirm = await Swal.fire({
    title: "Send Request to Admin?",
    html: `<b>Document:</b> ${docName || "Unknown"}<br><b>Process:</b> ${process || "Unknown"}`,
    icon: "question",
    showCancelButton: true,
    confirmButtonColor: "#4f46e5",
    cancelButtonColor: "#d33",
    confirmButtonText: "Yes, Send",
    cancelButtonText: "Cancel",
  });

  if (!confirm.isConfirmed) return;

  try {
    const res = await fetch("/request_admin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ doc_name: docName, process })
    });
    const data = await res.json();

    if (data.status === "success") {
      // ‚úÖ Play soft success sound
      const audio = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_c7ce81a4f2.mp3?filename=success-1-6297.mp3");
      audio.volume = 0.3;
      audio.play();

      // ‚úÖ Animated success popup
      Swal.fire({
        title: "üéâ Request Sent Successfully!",
        html: `
          <p>Your request for <b>${docName}</b> under the <b>${process}</b> process has been sent to the admin.</p>
          <p class="text-sm text-gray-500 mt-2">You will also receive a confirmation email shortly.</p>
        `,
        icon: "success",
        showConfirmButton: false,
        timer: 4000,
        timerProgressBar: true,
        backdrop: `
          rgba(0,0,123,0.4)
          url("https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif")
          left top no-repeat
        `
      });
    } else {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: data.message || "Failed to send request. Please try again.",
        confirmButtonColor: "#d33"
      });
    }
  } catch (err) {
    Swal.fire({
      icon: "error",
      title: "Network Error",
      text: "Could not connect to server. Please try again later.",
      confirmButtonColor: "#d33"
    });
  }
});


// Done
document.getElementById("doneBtn").addEventListener("click", ()=>{ window.location.href="/doc_summary"; });

// Detect location
document.getElementById("detectLocation").addEventListener("click", ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
      const data = await res.json();
      const addr = data.address;
      const locationString = [addr.suburb, addr.neighbourhood, addr.road, addr.county, addr.city, addr.state].filter(Boolean).join(", ");
      document.getElementById("location").value = locationString;
      // Fetch colleges
      const overpassQuery=`[out:json][timeout:25];(node["amenity"="college"](around:4000,${lat},${lon});node["amenity"="university"](around:4000,${lat},${lon}););out body;`;
      const overpassURL = "https://overpass-api.de/api/interpreter?data="+encodeURIComponent(overpassQuery);
      const resp = await fetch(overpassURL);
      const json = await resp.json();
      const colleges = json.elements.map(e=>e.tags.name).filter(Boolean);
      const dl=document.getElementById("collegeList"); dl.innerHTML="";
      colleges.forEach(c=>{ const opt=document.createElement("option"); opt.value=c; dl.appendChild(opt); });
    });
  }else Swal.fire("Error","Geolocation not supported","error");
});
</script>
</body>
</html>
